####################################
# Script de suppression du malware #
####################################

Write-Output "=== 1. Arrêt du processus malveillant ==="

# Identifier le PID et le chemin du binaire s'il tourne encore
$proc = Get-WmiObject Win32_Process -Filter "Name='SecurityHealth.exe'" `
        | Select-Object ProcessId,ExecutablePath

if ($proc) {
    Write-Output "Processus trouvé : PID=$($proc.ProcessId) Path=$($proc.ExecutablePath)"
    Stop-Process -Id $proc.ProcessId -Force
} else {
    Write-Output "Aucun processus SecurityHealth.exe en cours"
}

# Validation
if (-not (Get-Process -Name "SecurityHealth" -ErrorAction SilentlyContinue)) {
    Write-Output "OK : Processus arrêté."
}


Write-Output "`n=== 2. Suppression de la clé Run ==="

# Suppression de la persistance dans HKCU\Run
Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" `
                    -Name "SecurityHealth" -ErrorAction SilentlyContinue

# Validation
$runKey = Get-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
if (-not ($runKey.PSObject.Properties.Name -contains "SecurityHealth")) {
    Write-Output "OK : La clé Run a été supprimée."
}


Write-Output "`n=== 3. Suppression des copies persistantes ==="

# Emplacements connus identifiés pendant l’analyse
$paths = @(
    "C:\Program Files (x86)\Sudoku\platforms\SecurityHealth.exe",
    "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\SecurityHealth.exe",
    "C:\Users\Michu\SecurityHealth.exe"
)

foreach ($p in $paths) {
    if (Test-Path $p) {
        Remove-Item $p -Force -ErrorAction SilentlyContinue
        Write-Output "Supprimé : $p"
    }
}

# Validation
foreach ($p in $paths) {
    if (-not (Test-Path $p)) {
        Write-Output "OK : $p absent."
    }
}


Write-Output "`n=== 4. Suppression de tous les README.txt ==="

# Nettoyage global des README laissés par le ransomware
# Collectionne les fichiers README.txt sans les afficher
$readmes = Get-ChildItem -Path "C:\Users\Michu" -Recurse -Force -File -ErrorAction SilentlyContinue |
           Where-Object { $_.Name -ieq 'README.txt' }

foreach ($file in $readmes) {
    Remove-Item $file.FullName -Force -ErrorAction SilentlyContinue
}

Write-Output "README.txt supprimés : $($readmes.Count)"


# Validation
$remaining = Get-ChildItem -Path "C:\Users\Michu" -Recurse -Force -File -ErrorAction SilentlyContinue |
             Where-Object { $_.Name -ieq 'README.txt' }

if (-not $remaining) {
    Write-Output "OK : Tous les README.txt ont été supprimés."
}


Write-Output "`n=== Nettoyage terminé ==="
Write-Output "Redémarrer la Machine."

